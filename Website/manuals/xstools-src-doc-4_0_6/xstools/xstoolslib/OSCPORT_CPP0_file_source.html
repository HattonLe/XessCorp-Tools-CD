<HTML>
<HEAD>
<TITLE>XSTOOLs Source Code - oscport.cpp</TITLE>
<script type="text/javascript" src="../../common/js.js" language="JavaScript"></script>
<script type="text/javascript" src="leftmenu.js" language="JavaScript"></script>
<script type="text/javascript">
 var relPathToCommmon = "../../common/";
 var relPathToHelpDir = "../../common/help/";
 var toSearchPage     = "_search','../../search";
 Body1();
</script>
<div class="headerPage">oscport.cpp</div>
<div class="path"><a href="#" OnFocus="link('','../../index',this)" class="pathLink">XSTOOLs</A><img src="../../common/path-arrow.gif" class="path-arrow"><a href="#" OnFocus="link('_dir','xstoolslib0',this)" class="pathLink">xstoolslib</A><img src="../../common/path-arrow.gif" class="path-arrow"><span class="pathNonLink">oscport.cpp</span></div>
<script type="text/javascript">
 Body2();
 BodyLeftMenuStart();
WriteLeftMenu("","","","");
 BodyLeftMenuEnd();
 Body3();
</script>
<span class="tabInActive"><a href="#" OnFocus="linkTab('_file','oscport_cpp0','_description',this)" class="tabLinkInActive">Description</a></span>
<span class="tabInActive"><a href="#" OnFocus="linkTab('_file','oscport_cpp0','_overview',this)" class="tabLinkInActive">Overview</a></span>
<span class="tabInActive"><a href="#" OnFocus="linkTab('_file','oscport_cpp0','_includedfiles',this)" class="tabLinkInActive">Included files</a></span>
<span class="tabInActiveGrayout"><span class="tabLinkGrayout">Included by</span></span>
<span class="tabActive"><a href="#" OnFocus="linkTab('_file','oscport_cpp0','_source',this)" class="tabLinkActive">Source</a></span>
<script type="text/javascript">
 Body4();
</script>
<div class="contentAirTop"></div>
<pre class="codeExamples">
/*----------------------------------------------------------------------------------
  SOFTWARE LICENSE AGREEMENT
    1.  Permission to use, copy, modify, and distribute this software
        and its documentation, with or without modification, for any
        purpose and without fee or royalty is hereby granted, provided
        that you include the following on ALL copies of the software
        and documentation or portions thereof, including
        modifications, that you make:

            a.  The full text of this license in a location viewable to users
            of the redistributed or derivative work.

            b.  Notice of any changes or modifications to the files,
            including the date changes were made.

    2.  The name, servicemarks and trademarks of X Engineering
        Software Systems Corp. may NOT be used in advertising or
        publicity pertaining to the software without specific, written
        prior permission.

    3.  Title to copyright in this software and any associated
        documentation will at all times remain with X Engineering
        Software Systems Corp.

    4.  THIS SOFTWARE AND DOCUMENTATION IS PROVIDED "AS IS," AND X
        Engineering Software Systems Corp MAKES NO REPRESENTATIONS OR
        WARRANTIES, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO,
        WARRANTIES OF MERCHANTABILITY OR FITNESS FOR ANY PARTICULAR
        PURPOSE OR THAT THE USE OF THE SOFTWARE OR DOCUMENTATION WILL
        NOT INFRINGE ANY THIRD PARTY PATENTS, COPYRIGHTS, TRADEMARKS
        OR OTHER RIGHTS.

    5.  X Engineering Software Systems Corp WILL NOT BE LIABLE FOR ANY
        DAMAGES, INCLUDING BUT NOT LIMITED TO, DIRECT, INDIRECT,
        SPECIAL OR CONSEQUENTIAL, ARISING OUT OF ANY USE OF THE
        SOFTWARE OR DOCUMENTATION.

  ©2006 - X Engineering Software Systems Corp.  All rights reserved.
----------------------------------------------------------------------------------*/

#include &lt;dos.h&gt;

#include &lt;cstdlib&gt;
#include &lt;cstdio&gt;
#include &lt;fstream&gt;
#include &lt;sstream&gt;
#include &lt;ctime&gt;
#include &lt;string&gt;
using namespace std;

#ifdef WIN32
#include &lt;afxwin.h&gt;
#endif

#include "<a href="#" OnFocus="link('_file','oscport_h0',this)">oscport.h</a>"
#include "<a href="#" OnFocus="link('_file','utils_h0',this)">utils.h</a>"


// Some values for the DS1075 programmable oscillator
static const unsigned int OscCmdLength      = 8;    // length of oscillator commands 
static const unsigned int OscDataLength     = 9;    // length of oscillator data
static const unsigned int OscCmdWriteDIV    = 1;    // command for writing clock divisor 
static const unsigned int OscCmdWriteMUX    = 2;    // command for writing clock multiplexer 

static const unsigned int OneDuration       = 5L;   // duration of a logic 1 in the osc. data stream
static const unsigned int ZeroDuration      = 112L; // duration of a logic 0
static const unsigned int <a href="#" OnFocus="link('_member','BitDuration0',this)">BitDuration</a>      = 150L; // total bit duration


/// Create a DS1075 prog. oscillator controller port.
<a href="#" OnFocus="link('_member','OscPort60241441',this)">OscPort::OscPort</a>(void)
{
    ;
}


/// Create a DS1075 prog. oscillator controller port.
<a href="#" OnFocus="link('_member','OscPort60241441',this)">OscPort::OscPort</a>(<a href="#" OnFocus="link('_class','XSError0',this)">XSError</a>* e,   ///&lt; pointer to error reporting object
                   unsigned int portNum,    ///&lt; parallel port number
                   unsigned int invMask,    ///&lt; inversion mask for the parallel port
                   unsigned int pos_osc)    ///&lt; bit position in parallel port of osc. pin
{
    <a href="#" OnFocus="link('_member','Setup4236493299',this)">Setup</a>(e,portNum,invMask,pos_osc);
}


/// Setup a DS1075 prog. oscillator controller port.
int <a href="#" OnFocus="link('_member','Setup4236493299',this)">OscPort::Setup</a>(<a href="#" OnFocus="link('_class','XSError0',this)">XSError</a>* e,   ///&lt; pointer to error reporting object
                   unsigned int portNum,    ///&lt; parallel port number
                   unsigned int invMask,    ///&lt; inversion mask for the parallel port
                   unsigned int pos_osc)    ///&lt; bit position in parallel port of osc. pin
{
    <a href="#" OnFocus="link('_member','posOsc518326',this)">posOsc</a> = pos_osc;
    return <a href="#" OnFocus="link('_member','Setup1571714867',this)">PPort::Setup</a>(e,portNum,invMask);
}


/// Reset the programmable oscillator.
void <a href="#" OnFocus="link('_member','ResetOsc60241441',this)">OscPort::ResetOsc</a>(void)
{
    <a href="#" OnFocus="link('_member','Out2912582438',this)">Out</a>(0,posOsc,posOsc);              // lower data bit 0
    <a href="#" OnFocus="link('_member','InsertDelay359930342',this)">InsertDelay</a>(1200L,MICROSECONDS);   // wait for DS1075 to see reset level
    <a href="#" OnFocus="link('_member','Out2912582438',this)">Out</a>(1,posOsc,posOsc);              // now remove reset level
    <a href="#" OnFocus="link('_member','InsertDelay359930342',this)">InsertDelay</a>(1200L,MICROSECONDS);   // wait for presence pulse from DS1075
}


/// Send a bit of data to the programmable oscillator.
void <a href="#" OnFocus="link('_member','SendOscBit2513466020',this)">OscPort::SendOscBit</a>(unsigned char b)
{
    if(b)   // send a logic 1
    {
        <a href="#" OnFocus="link('_member','Out2912582438',this)">Out</a>(0,posOsc,posOsc);
        <a href="#" OnFocus="link('_member','InsertDelay359930342',this)">InsertDelay</a>(OneDuration,MICROSECONDS);
        <a href="#" OnFocus="link('_member','Out2912582438',this)">Out</a>(1,posOsc,posOsc);
        <a href="#" OnFocus="link('_member','InsertDelay359930342',this)">InsertDelay</a>(BitDuration-OneDuration,MICROSECONDS);
    }
    else    // send a logic 0
    {
        <a href="#" OnFocus="link('_member','Out2912582438',this)">Out</a>(0,posOsc,posOsc);
        <a href="#" OnFocus="link('_member','InsertDelay359930342',this)">InsertDelay</a>(ZeroDuration,MICROSECONDS);
        <a href="#" OnFocus="link('_member','Out2912582438',this)">Out</a>(1,posOsc,posOsc);
        <a href="#" OnFocus="link('_member','InsertDelay359930342',this)">InsertDelay</a>(BitDuration-ZeroDuration,MICROSECONDS);
    }
}


/// Send a command word to the programmable oscillator.
void <a href="#" OnFocus="link('_member','IssueOscCmd3135533727',this)">OscPort::IssueOscCmd</a>(unsigned int cmd)
{
    for(int i=0; i&lt;OscCmdLength; i++, cmd&gt;&gt;=1)
        <a href="#" OnFocus="link('_member','SendOscBit2513466020',this)">SendOscBit</a>(cmd&amp;1);
}


/// Send a data word to the programmable oscillator.
void <a href="#" OnFocus="link('_member','SendOscData3135533727',this)">OscPort::SendOscData</a>(unsigned int data)
{
    for(int i=0; i&lt;OscDataLength; i++, data&gt;&gt;=1)
        <a href="#" OnFocus="link('_member','SendOscBit2513466020',this)">SendOscBit</a>(data&amp;1);
}


/// Set the programmable oscillator frequency.
bool <a href="#" OnFocus="link('_member','SetOscFrequency4061435083',this)">OscPort::SetOscFrequency</a>(int div,  ///&lt; divisor for master frequency
                    bool extOscPresent) ///&lt; if true, master frequency arrives from external source, otherwise use internal 100 MHz source in DS1075
{
    <a href="#" OnFocus="link('_class','XSError0',this)">XSError</a>&amp; <a href="#" OnFocus="link('_member','../xsi2c/err0',this)">err</a> = <a href="#" OnFocus="link('_member','GetErr259477277',this)">GetErr</a>();
    if(div&lt;1)
    {
        string msg("Clock divisor must be greater than zero!!\n");
        <a href="#" OnFocus="link('_member','../xsi2c/err0',this)">err</a>.<a href="#" OnFocus="link('_member','SimpleMsg3476940419',this)">SimpleMsg</a>(XSErrorMajor,msg);
        return false;
    }
    if(div&gt;2052)
    {
        string msg("Clock divisor must be less than 2053!!\n");
        <a href="#" OnFocus="link('_member','../xsi2c/err0',this)">err</a>.<a href="#" OnFocus="link('_member','SimpleMsg3476940419',this)">SimpleMsg</a>(XSErrorMajor,msg);
        return false;
    }

    int div1 = div==1 ? 1:0;    // set divide-by-1 bit if clock is not divided down
    int prescaleOff = 1;        // turn off prescalar
    int prescaleByTwo = 0;
    if(!extOscPresent)      // setup prescalar circuitry if DS1075 internal oscillator is used
    {
        if(div&gt;1026)
        {
            prescaleOff = 0;    // turn on the prescalar
            prescaleByTwo = 0;  // enable divide-by-four by turning off the divide-by-two prescalar
            div /= 4;           // reduce divisor
        }
        else if(div&gt;513)
        {
            prescaleOff = 0;    // turn on the prescalar
            prescaleByTwo = 1;  // turn on the divide-by-two prescalar
            div /= 2;
        }
    }
    div = div&gt;513 ? 513:div;    // divisor saturates at 513 if external oscillator is used
    // The divisor must be adjusted to get the frequency right as follows:
    //      original    adjusted    resulting
    //      div         div         frequency
    //      ----------------------------------
    //      1            -1         100 MHz (no division)
    //      2             0          50 MHz (divide by 2)
    //      3             1          33 MHz (divide by 3)
    //      4             2          25 MHz (divide by 4)
    //      ...         ...         ...
    //      511         509         
    //      512         510         
    //      513         511
    div -= 2;

    int powerUp = 1;        // keep the oscillator powered up
    int disable0 = 1;       // disable the OUT0 output of the DS1075 (it's not connected on the XS Boards)
    int mux = (disable0&lt;&lt;5) | (powerUp&lt;&lt;4) | (prescaleByTwo&lt;&lt;3) |(prescaleOff&lt;&lt;2) | (div1&lt;&lt;1) | (extOscPresent ? 1:0);

    <a href="#" OnFocus="link('_member','Out2912582438',this)">Out</a>(1,posOsc,posOsc);  // make sure the osc. data pin starts out high

    // program divisor register of the DS1075
    <a href="#" OnFocus="link('_member','ResetOsc60241441',this)">ResetOsc</a>();
    <a href="#" OnFocus="link('_member','IssueOscCmd3135533727',this)">IssueOscCmd</a>(OscCmdWriteDIV);
    <a href="#" OnFocus="link('_member','SendOscData3135533727',this)">SendOscData</a>(div);
    <a href="#" OnFocus="link('_member','InsertDelay359930342',this)">InsertDelay</a>(240,MICROSECONDS);

    // program multiplexor register of the DS1075
    <a href="#" OnFocus="link('_member','ResetOsc60241441',this)">ResetOsc</a>();
    <a href="#" OnFocus="link('_member','IssueOscCmd3135533727',this)">IssueOscCmd</a>(OscCmdWriteMUX);
    <a href="#" OnFocus="link('_member','SendOscData3135533727',this)">SendOscData</a>(mux);
    <a href="#" OnFocus="link('_member','InsertDelay359930342',this)">InsertDelay</a>(240,MICROSECONDS);

    return true;
}
</pre><div class="contentAirBottom"></div>
<script type="text/javascript">
 Body5();
Statistics("","","","","");
 Body6();
SetPageTab('_file','_source');
</script>
