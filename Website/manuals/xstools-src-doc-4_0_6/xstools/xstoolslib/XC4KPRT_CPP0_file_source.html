<HTML>
<HEAD>
<TITLE>XSTOOLs Source Code - xc4kprt.cpp</TITLE>
<script type="text/javascript" src="../../common/js.js" language="JavaScript"></script>
<script type="text/javascript" src="leftmenu.js" language="JavaScript"></script>
<script type="text/javascript">
 var relPathToCommmon = "../../common/";
 var relPathToHelpDir = "../../common/help/";
 var toSearchPage     = "_search','../../search";
 Body1();
</script>
<div class="headerPage">xc4kprt.cpp</div>
<div class="path"><a href="#" OnFocus="link('','../../index',this)" class="pathLink">XSTOOLs</A><img src="../../common/path-arrow.gif" class="path-arrow"><a href="#" OnFocus="link('_dir','xstoolslib0',this)" class="pathLink">xstoolslib</A><img src="../../common/path-arrow.gif" class="path-arrow"><span class="pathNonLink">xc4kprt.cpp</span></div>
<script type="text/javascript">
 Body2();
 BodyLeftMenuStart();
WriteLeftMenu("","","","");
 BodyLeftMenuEnd();
 Body3();
</script>
<span class="tabInActive"><a href="#" OnFocus="linkTab('_file','xc4kprt_cpp0','_description',this)" class="tabLinkInActive">Description</a></span>
<span class="tabInActive"><a href="#" OnFocus="linkTab('_file','xc4kprt_cpp0','_overview',this)" class="tabLinkInActive">Overview</a></span>
<span class="tabInActive"><a href="#" OnFocus="linkTab('_file','xc4kprt_cpp0','_includedfiles',this)" class="tabLinkInActive">Included files</a></span>
<span class="tabInActiveGrayout"><span class="tabLinkGrayout">Included by</span></span>
<span class="tabActive"><a href="#" OnFocus="linkTab('_file','xc4kprt_cpp0','_source',this)" class="tabLinkActive">Source</a></span>
<script type="text/javascript">
 Body4();
</script>
<div class="contentAirTop"></div>
<pre class="codeExamples">
/*----------------------------------------------------------------------------------
  SOFTWARE LICENSE AGREEMENT
    1.  Permission to use, copy, modify, and distribute this software
        and its documentation, with or without modification, for any
        purpose and without fee or royalty is hereby granted, provided
        that you include the following on ALL copies of the software
        and documentation or portions thereof, including
        modifications, that you make:

            a.  The full text of this license in a location viewable to users
            of the redistributed or derivative work.

            b.  Notice of any changes or modifications to the files,
            including the date changes were made.

    2.  The name, servicemarks and trademarks of X Engineering
        Software Systems Corp. may NOT be used in advertising or
        publicity pertaining to the software without specific, written
        prior permission.

    3.  Title to copyright in this software and any associated
        documentation will at all times remain with X Engineering
        Software Systems Corp.

    4.  THIS SOFTWARE AND DOCUMENTATION IS PROVIDED "AS IS," AND X
        Engineering Software Systems Corp MAKES NO REPRESENTATIONS OR
        WARRANTIES, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO,
        WARRANTIES OF MERCHANTABILITY OR FITNESS FOR ANY PARTICULAR
        PURPOSE OR THAT THE USE OF THE SOFTWARE OR DOCUMENTATION WILL
        NOT INFRINGE ANY THIRD PARTY PATENTS, COPYRIGHTS, TRADEMARKS
        OR OTHER RIGHTS.

    5.  X Engineering Software Systems Corp WILL NOT BE LIABLE FOR ANY
        DAMAGES, INCLUDING BUT NOT LIMITED TO, DIRECT, INDIRECT,
        SPECIAL OR CONSEQUENTIAL, ARISING OUT OF ANY USE OF THE
        SOFTWARE OR DOCUMENTATION.

  ©2006 - X Engineering Software Systems Corp.  All rights reserved.
----------------------------------------------------------------------------------*/


#include &lt;dos.h&gt;
#include &lt;cstdlib&gt;
#include &lt;cstdio&gt;
#include &lt;fstream&gt;
#include &lt;sstream&gt;
#include &lt;ctime&gt;
#include &lt;string&gt;
using namespace std;

#ifdef WIN32
#include &lt;afxwin.h&gt;
#endif

#include "<a href="#" OnFocus="link('_file','utils_h0',this)">utils.h</a>"
#include "<a href="#" OnFocus="link('_file','xc4kprt_h0',this)">xc4kprt.h</a>"


/// Instantiate an XC4KPort object on a given parallel port.
<a href="#" OnFocus="link('_member','XC4KPort141718704',this)">XC4KPort::XC4KPort</a>(void)
{
    <a href="#" OnFocus="link('_member','progressGauge243775534',this)">progressGauge</a> = NULL;
}


/// Instantiate an XC4KPort object on a given parallel port.
<a href="#" OnFocus="link('_member','XC4KPort141718704',this)">XC4KPort::XC4KPort</a>(<a href="#" OnFocus="link('_class','XSError0',this)">XSError</a>* e, ///&lt; pointer to error reporting object
                   unsigned int portNum, ///&lt; parallel port number
                   unsigned int invMask, ///&lt; inversion mask for the parallel port
                   unsigned int posCCLK, ///&lt; bit position in parallel port of CCLK pin
                   unsigned int posPROG, ///&lt; bit position in parallel port of PROGRAM pin
                   unsigned int posDIN, ///&lt; bit position in parallel port of DIN pin
                   unsigned int posDONE) ///&lt; bit position in parallel port of DONE pin
{
    <a href="#" OnFocus="link('_member','progressGauge243775534',this)">progressGauge</a> = NULL;
    <a href="#" OnFocus="link('_member','Setup2737913540',this)">Setup</a>(e,portNum,invMask,posCCLK,posPROG,posDIN,posDONE);
}


/// Setup an XC4KPort object on a given parallel port.
///\return true if the operation was a success, false otherwise
bool <a href="#" OnFocus="link('_member','Setup2737913540',this)">XC4KPort::Setup</a>(<a href="#" OnFocus="link('_class','XSError0',this)">XSError</a>* e, ///&lt; pointer to error reporting object
                   unsigned int portNum, ///&lt; parallel port number
                   unsigned int invMask, ///&lt; inversion mask for the parallel port
                   unsigned int posCCLK, ///&lt; bit position in parallel port of CCLK pin
                   unsigned int posPROG, ///&lt; bit position in parallel port of PROGRAM pin
                   unsigned int posDIN, ///&lt; bit position in parallel port of DIN pin
                   unsigned int posDONE) ///&lt; bit position in parallel port of DONE pin
{
    return <a href="#" OnFocus="link('_member','Setup2737922981',this)">CnfgPort::Setup</a>(e,portNum,invMask,posCCLK,posPROG,posDIN,posDONE);
}


static const int DeviceFieldType = 0x62;        // field type for the FPGA device identifier

/// Get the chip identifier from the FPGA bitstream.
///\return the chip identifier
string <a href="#" OnFocus="link('_member','GetChipType435841068',this)">XC4KPort::GetChipType</a>(istream&amp; is) ///&lt; stream that delivers the bitstream
{
    <a href="#" OnFocus="link('_class','XSError0',this)">XSError</a>&amp; <a href="#" OnFocus="link('_member','../xsi2c/err0',this)">err</a> = <a href="#" OnFocus="link('_member','GetErr259477277',this)">GetErr</a>();
    
    if(is.eof()!=0)
        return (string)""; // exit if no BIT stream exists
    
    // jump over the first field of the BIT file
    long unsigned int fieldLength = <a href="#" OnFocus="link('_member','GetInteger1332633361',this)">GetInteger</a>(is);
    assert(fieldLength!=0);
    is.ignore(fieldLength);
    
    // process the second field
    fieldLength = <a href="#" OnFocus="link('_member','GetInteger1332633361',this)">GetInteger</a>(is);
    assert(fieldLength==1);
    
    // now look for the field with the chip identifier
    bool status = <a href="#" OnFocus="link('_member','ScanForField2849822024',this)">ScanForField</a>(is,DeviceFieldType);
    assert(status==true);
    fieldLength = <a href="#" OnFocus="link('_member','GetInteger1332633361',this)">GetInteger</a>(is);
    assert(fieldLength&gt;0 &amp;&amp; fieldLength&lt;100);
    char <a href="#" OnFocus="link('_member','chipType243775534',this)">chipType</a>[100];
    unsigned int i;
    for(i=0; i&lt;fieldLength; i++)
        is &gt;&gt; <a href="#" OnFocus="link('_member','chipType243775534',this)">chipType</a>[i];
    <a href="#" OnFocus="link('_member','chipType243775534',this)">chipType</a>[i] = 0;        // terminate string
    return <a href="#" OnFocus="link('_member','chipType243775534',this)">chipType</a>;        // return the chip type
}



/// Get the chip identifier from the FPGA bitstream.
///\return the chip identifier
string <a href="#" OnFocus="link('_member','GetChipType435841068',this)">XC4KPort::GetChipType</a>(string&amp; bitfileName)    ///&lt; file containing the FPGA bitstream
{
    <a href="#" OnFocus="link('_class','XSError0',this)">XSError</a>&amp; <a href="#" OnFocus="link('_member','../xsi2c/err0',this)">err</a> = <a href="#" OnFocus="link('_member','GetErr259477277',this)">GetErr</a>();
    
    if(bitfileName.compare("")==0)
        return (string)""; // exit if no BIT file was given
    
    ifstream is(bitfileName.c_str(),ios::binary);
    if(!is || is.fail()!=0)
    { // error if given file could not be opened
        <a href="#" OnFocus="link('_member','../xsi2c/err0',this)">err</a>.<a href="#" OnFocus="link('_member','SetSeverity3409672334',this)">SetSeverity</a>(XSErrorMajor);
        <a href="#" OnFocus="link('_member','../xsi2c/err0',this)">err</a> &lt;&lt; "could not open " &lt;&lt; bitfileName.c_str() &lt;&lt; "\n";
        <a href="#" OnFocus="link('_member','../xsi2c/err0',this)">err</a>.<a href="#" OnFocus="link('_member','EndMsg60232619',this)">EndMsg</a>();
        return (string)"";
    }
    
    // now get the chip identifier from the bitstream file
    string <a href="#" OnFocus="link('_member','chipType243775534',this)">chipType</a> = <a href="#" OnFocus="link('_member','GetChipType435841068',this)">GetChipType</a>(is);
    
    is.close();
    
    return <a href="#" OnFocus="link('_member','chipType243775534',this)">chipType</a>;
}


/// Initialize FPGA configuration pins.
void <a href="#" OnFocus="link('_member','InitConfigureFPGA141718704',this)">XC4KPort::InitConfigureFPGA</a>(void)
{
    <a href="#" OnFocus="link('_member','SetPROG822561128',this)">SetPROG</a>(1);
    <a href="#" OnFocus="link('_member','SetCCLK822561128',this)">SetCCLK</a>(0);
    <a href="#" OnFocus="link('_member','Out2912582438',this)">Out</a>(0x3,6,7);  // set XC4000 mode pins to "slave serial" config. mode
}


/// Send out a byte of configuration information.
void <a href="#" OnFocus="link('_member','ConfigureFPGA912622780',this)">XC4KPort::ConfigureFPGA</a>(unsigned char b)  ///&lt; configuration byte from FPGA bitstream
{
    // configuration bytes for the XC4000 programming pins only contain
    // values for the DIN pin, so eight clock pulses are needed per byte.
    for(int i=0; i&lt;8; i++)
    {
        <a href="#" OnFocus="link('_member','SetDIN822561128',this)">SetDIN</a>(b&amp;0x80 ? 1:0);  // byte is sent MSB first
        b &lt;&lt;= 1;
        <a href="#" OnFocus="link('_member','PulseCCLK141699537',this)">PulseCCLK</a>();
    }
}


static const int BitstreamFieldType = 0x65; // field type for the bitstream data

/// Process a stream and send the configuration bitstream to the board.
///\return true if the operation was a success, false otherwise
bool <a href="#" OnFocus="link('_member','ConfigureFPGA912622780',this)">XC4KPort::ConfigureFPGA</a>(istream&amp; is)  ///&lt; stream that delivers the FPGA bitstream
{
    <a href="#" OnFocus="link('_class','XSError0',this)">XSError</a>&amp; <a href="#" OnFocus="link('_member','../xsi2c/err0',this)">err</a> = <a href="#" OnFocus="link('_member','GetErr259477277',this)">GetErr</a>();
    
    if(is.eof()!=0)
        return false; // exit if no BIT stream exists

    assert(progressGauge != NULL);  // make sure progress indicator is initialized

    // show the progress indicator
    <a href="#" OnFocus="link('_member','progressGauge243775534',this)">progressGauge</a>-&gt;<a href="#" OnFocus="link('_member','Report2561259521',this)">Report</a>(0);
    
    // jump over the first field of the BIT file
    long unsigned int fieldLength = <a href="#" OnFocus="link('_member','GetInteger1332633361',this)">GetInteger</a>(is);
    assert(fieldLength!=0);
    is.ignore(fieldLength);
    
    // process the second field
    fieldLength = <a href="#" OnFocus="link('_member','GetInteger1332633361',this)">GetInteger</a>(is);
    assert(fieldLength==1);
    
    // now look for the field with the bitstream data
    bool status = <a href="#" OnFocus="link('_member','ScanForField2849822024',this)">ScanForField</a>(is,BitstreamFieldType);
    assert(status==true);
    
    // now we are at the start of the configuration bits
    fieldLength = <a href="#" OnFocus="link('_member','GetInteger1332633361',this)">GetInteger</a>(is,4); // get the length of the bit stream
    assert(fieldLength&gt;0);
#if DEBUG
    cerr &lt;&lt; "bit stream field length = " &lt;&lt; fieldLength &lt;&lt; "\n";
#endif

    // start the configuration process
    <a href="#" OnFocus="link('_member','PulsePROG141699537',this)">PulsePROG</a>();                 // pulse the PROGRAM pin to start the configuration of the FPGA
    <a href="#" OnFocus="link('_member','InsertDelay359930342',this)">InsertDelay</a>(300,MILLISECONDS); // insert 300 ms delay after PROGRAM pin goes high

    for(long unsigned int i=0; i&lt;fieldLength; i++)
    { // read the bytes and send the config. bits to the board
        unsigned char byte;
        is.read((char*)&amp;byte,1);
        assert(is.eof()==0);    // should not hit end-of-file
        <a href="#" OnFocus="link('_member','ConfigureFPGA912622780',this)">ConfigureFPGA</a>(byte);
        // output some feedback as the configuration proceeds
        if((i%1000)==0)
            <a href="#" OnFocus="link('_member','progressGauge243775534',this)">progressGauge</a>-&gt;<a href="#" OnFocus="link('_member','Report2561259521',this)">Report</a>(is.tellg());
    }
    <a href="#" OnFocus="link('_member','progressGauge243775534',this)">progressGauge</a>-&gt;<a href="#" OnFocus="link('_member','Report2561259521',this)">Report</a>(is.tellg()); // this should set gauge to 100%
    
    // clock a few more times at the end of the configuration process
    // to clean things up...
    for(int ii=0; ii&lt;4; ii++)
        <a href="#" OnFocus="link('_member','PulseCCLK141699537',this)">PulseCCLK</a>();

    // insert a delay to let the chip initialize
    <a href="#" OnFocus="link('_member','InsertDelay359930342',this)">InsertDelay</a>(100,MILLISECONDS);
    
#if DEBUG
    cerr &lt;&lt; "exiting ConfigureFPGA()\n";
#endif
    
    return true;
}



/// Process an FPGA bitstream file and send the configuration bitstream to the board.
///\return true if the operation was a success, false otherwise
bool <a href="#" OnFocus="link('_member','ConfigureFPGA912622780',this)">XC4KPort::ConfigureFPGA</a>(string&amp; fileName) ///&lt; file with FPGA bitstream
{
    <a href="#" OnFocus="link('_class','XSError0',this)">XSError</a>&amp; <a href="#" OnFocus="link('_member','../xsi2c/err0',this)">err</a> = <a href="#" OnFocus="link('_member','GetErr259477277',this)">GetErr</a>();
    
    if(<a href="#" OnFocus="link('_member','../xssetsaa711X/fileName0',this)">fileName</a>.length()==0)
        return false;  // stop if no SVF or BIT file was given
    
    ifstream is(<a href="#" OnFocus="link('_member','../xssetsaa711X/fileName0',this)">fileName</a>.c_str(),ios::binary);  // otherwise open BIT or SVF file
    if(!is || is.fail() || is.eof())
    { // error - couldn't open file
        <a href="#" OnFocus="link('_member','../xsi2c/err0',this)">err</a>.<a href="#" OnFocus="link('_member','SetSeverity3409672334',this)">SetSeverity</a>(XSErrorMajor);
        <a href="#" OnFocus="link('_member','../xsi2c/err0',this)">err</a> &lt;&lt; "could not open " &lt;&lt; <a href="#" OnFocus="link('_member','../xssetsaa711X/fileName0',this)">fileName</a>.c_str() &lt;&lt; "\n";
        <a href="#" OnFocus="link('_member','../xsi2c/err0',this)">err</a>.<a href="#" OnFocus="link('_member','EndMsg60232619',this)">EndMsg</a>();
        return false;
    }
    
    // determine the size of the file
    is.seekg(0,ios::end);   // move pointer to end of file
    streampos streamEndPos = is.tellg();    // pointer position = position of end of file

    is.seekg(0,ios::beg);   // return pointer to beginning of file

    string desc("Configure FPGA"), subdesc("Downloading "+<a href="#" OnFocus="link('_member','StripPrefix67554305',this)">StripPrefix</a>(fileName));
    <a href="#" OnFocus="link('_member','progressGauge243775534',this)">progressGauge</a> = new <a href="#" OnFocus="link('_class','Progress0',this)">Progress</a>(&amp;err,desc,subdesc,0,streamEndPos);
    
    bool status = <a href="#" OnFocus="link('_member','ConfigureFPGA912622780',this)">ConfigureFPGA</a>(is);
    
    delete <a href="#" OnFocus="link('_member','progressGauge243775534',this)">progressGauge</a>;
    
    is.close();  // close-up the hex file
    
    return status;
}
</pre><div class="contentAirBottom"></div>
<script type="text/javascript">
 Body5();
Statistics("","","","","");
 Body6();
SetPageTab('_file','_source');
</script>
